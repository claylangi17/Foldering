# Active Context: AI-Powered Purchase Order Classification System

## 1. Current Work Focus
- **Implementing "Mini Dashboard" Feature**:
    - Backend: Created schema, service, and router for dashboard data.
    - Frontend: Created API function, `MiniDashboard` component, and integrated into main dashboard page.
- **Implementing "Editable Keterangan" Feature**: This was recently completed.
- **Implementing "Filter by Folder/Month" Feature (Phase 1 - Client-side)**: This was recently completed.
- **Implementing "Item Name Search" Feature**: This was recently completed.
- **Implementing "Export PDF" Feature**: This was recently completed.
- **Finalizing "Cumulative per Item" Feature**: This was recently completed.
- **Continuing "Checklist SPV" Feature**: Backend and frontend foundations are in place.

## 2. Recent Changes & Decisions
- **Implemented "Editable Keterangan" Feature**:
    - Added `updatePOKeterangan` to `frontend/src/lib/api.ts`.
    - Made `Keterangan` cell editable (debounced) for SPV users in `item-columns.tsx`.
- **Implemented "Filter by Folder/Month" Feature (Client-side)**:
    - Added search input for L1/L2 folder names in `layers/[[...slug]]/page.tsx`.
    - Added Year/Month dropdowns to filter items by `TGL_PO` in `layers/[[...slug]]/page.tsx`.
    - Added `select` and `separator` components via Shadcn CLI.
    - Corrected TypeScript errors for `TGL_PO` date handling and `EtlParameterForm` import.
- **Implemented "Item Name Search" Feature**:
    - Added client-side item search input to `layers/[[...slug]]/page.tsx`.
    - DataTable now displays filtered items based on Item Name or Item Code.
    - PDF export considers the item search filter.
- **Implemented "Export PDF" Feature**:
    - Added `jspdf` and `jspdf-autotable` to frontend.
    - Added "Export to PDF" button and `exportToPDF` function to `layers/[[...slug]]/page.tsx`.
- **Implemented "Cumulative per Item" Feature**:
    - Backend: Modified `classification_service.py` to include cumulative QTY and Amount using SQL window functions. Updated `po_schemas.py`.
    - Frontend: Updated `api.ts` and `item-columns.tsx` to display new cumulative fields.
- **Implemented "Checklist SPV" Feature (Ongoing)**:
    - **Backend**: Created user schemas, security utilities, auth service, auth router (register, login, users/me), and SPV-specific dependency. Secured PO update endpoint.
    - **Frontend**: Created Login/Register pages, `AuthContext` for global state, protected dashboard layout, and role-based editable "Checklist" in `item-columns.tsx`. Added `updatePOChecklist` to `api.ts`.
- **Shift in Classification Strategy**: Moved from a 3-level KMeans clustering approach to a 2-level folder structure generated by rule-based parsing of item descriptions.
- **Parsing Logic Implementation & Refinement**: Implemented and refined `parse_item_description_for_folders` in `ml/training_pipeline.py` and `ml/inference.py`.
- **Database Population Update**: `ml/training_pipeline.py` populates `layer_definitions` and `item_classifications` based on parsing.
- **API Modifications**: Updated `etl_ml_router.py`, `classification_service.py`, and `classification_router.py` for parsing-based system.
- **Frontend Updates for Parsing**: Adjusted `api.ts` and `page.tsx` in `layers/[[...slug]]` for 2-level navigation and data display.
- **Full project uploaded to GitHub repository `claylangi17/Foldering` on the `main` branch.**

## 3. Next Steps
1.  **Test Checklist SPV Feature**: 
    *   Verify SPV users can check/uncheck the box.
    *   Check browser console logs added to `ChecklistCell` in `item-columns.tsx` to trace role, token, and API call status if issues persist.
    *   Verify checked rows have a light green background.
2.  **Test "Export PDF" Feature**:
    *   Attempt PDF export.
    *   Check browser console logs added to `exportToPDF` in `page.tsx` for trigger confirmation, data counts, headers, rows, and any errors.
3.  **Test "Mini Dashboard" Feature**: Verify data display and accuracy.
4.  **Test "Editable Keterangan" Feature**: Verify SPV users can edit Keterangan and changes persist.
5.  **Test "Filter by Folder/Month" Feature (Client-side)**: Verify folder name search and item date filtering.
6.  **Test "Item Name Search" Feature**: Verify client-side filtering of items.
7.  **Checklist SPV - Final Touches**:
    -   Role management UI (currently manual DB edit).
    -   Robust error handling and UI feedback for checklist updates.
    -   Consider data refresh strategy after checklist update.
8.  **Address Other Pending Features (from `projectbrief.md` and `progress.md`)**:
    -   Consider backend enhancements for "Filter by Month" if client-side is insufficient.
9.  **Further Refine Parsing Rules (Iterative)**: Based on ongoing feedback.
10. **UI/UX Review**: For folder names, item counts, and overall navigation.

## 4. Active Decisions & Considerations
- **Rule-Based Parsing as Primary Method**: The core classification now relies on explicit parsing rules, not unsupervised ML clustering.
- **Modularity is Key**: Continue to adhere to the modular structure.
- **User Experience for Folders**: The "Google Drive-like" navigation for the 2-level folder structure remains a core UX requirement.
- **Data Integrity**: Ensure all data transformations and displays are accurate.
- **Parsing Rule Maintainability**: The set of parsing rules will likely need to grow and be maintained as new item types are encountered. Consider how to make this manageable.
- Decision: Use `main` as the primary Git branch.
- Decision: Track `frontend` directory files directly in the main project, not as a submodule.

## 5. Important Patterns & Preferences (Emerging)
- **Structured Documentation**: The Memory Bank system is central.
- **Iterative Development & Testing**: The shift in requirements highlighted the need for quick iteration, testing, and debugging across the full stack.
- **User-Centric Design**: The folder structure is now directly tied to user-defined examples and expected categorization.
- Ensured `.gitignore` correctly excludes `.env` and `.venv`.
- Handled Git warning regarding embedded repositories by removing the nested `.git` folder and re-adding files.

## 6. Learnings & Project Insights
- The project's classification approach has fundamentally changed from ML-driven clustering to explicit rule-based parsing. This requires significant changes to the "ML" components.
- Clear communication of requirements is vital, especially for complex concepts like "classification" or "foldering."
- The importance of robust and adaptable parsing rules for item descriptions is now paramount.
- Iterative testing and debugging across backend, data processing scripts, and frontend is crucial for ensuring data flows correctly and the UI reflects the intended structure.
- Added debugging logs to frontend components (`item-columns.tsx`, `page.tsx`) to diagnose SPV checklist and PDF export issues.
- Modified `data-table.tsx` to visually highlight checked rows for better usability.
