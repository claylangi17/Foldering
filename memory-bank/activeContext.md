# Active Context: AI-Powered Purchase Order Classification System

## 1. Current Work Focus
- **Refinement of Parsing-Based Folder System & Testing**: Implementing and testing the 2-level folder structure based on direct parsing of item descriptions.
- **Troubleshooting and Bug Fixing**: Addressing issues identified during testing of the new parsing logic and its integration with the backend and frontend.
- **Memory Bank Update**: Reflecting the significant shift from KMeans clustering to rule-based parsing in all relevant documentation.

## 2. Recent Changes & Decisions
- **Shift in Classification Strategy**: Moved from a 3-level KMeans clustering approach to a 2-level folder structure generated by rule-based parsing of item descriptions, as per user clarification.
    - L1 Folder: General category (e.g., "DUPLEX 450GSM").
    - L2 Folder: Specific item type (e.g., "DUPLEX 450GSM/58.5X92CM"), which lists POs.
- **Parsing Logic Implementation & Refinement**:
    - Implemented and refined `parse_item_description_for_folders` in `ml/training_pipeline.py` and `ml/inference.py`.
    - Added new regex patterns for "INK", "TONER", and dimensional products (e.g., "100X200X50CM", "50 X 70 MM").
    - Re-ordered parsing rules for better specificity.
- **Database Population Update**:
    - `ml/training_pipeline.py` now populates `layer_definitions` with L1 and L2 parsed folder names and their parent-child relationships.
    - `item_classifications` now links each PO item to its L2 folder name.
    - Implemented more robust clearing of old classification data before new data population.
- **API Modifications**:
    - `api/routers/etl_ml_router.py`: `/train-ml-model` endpoint now triggers `run_folder_generation_pipeline`; `/classify-new-item` uses parsing.
    - `api/services/classification_service.py`: Updated queries to correctly fetch hierarchical data and calculate item counts for the new 2-level parsed structure.
    - `api/routers/classification_router.py`: Ensured slug-based navigation correctly interacts with the service layer.
- **Frontend Updates**:
    - `frontend/src/lib/api.ts`: API client functions updated for new backend logic.
    - `frontend/src/app/(dashboard_layout)/layers/[[...slug]]/page.tsx`:
        - Logic adjusted to handle 2-level folder navigation.
        - Corrected API calls and data property access to display L1 folders, L2 specific item folders, and finally the PO item lists.
        - Resolved issues with `React.use(params)` for slug handling.
        - Updated item table to display all requested columns.
- **Troubleshooting**:
    - Resolved `ModuleNotFoundError` for ML scripts by running as modules.
    - Fixed MySQL access denied errors by correcting `.env` file parsing and `load_dotenv()` usage.
    - Addressed `KeyError` in pandas `.loc` by aligning DataFrame indices.
    - Corrected frontend display issues by aligning Pydantic models, service data mapping, and frontend data access.

## 3. Next Steps
1.  **Finalize Testing**: Complete end-to-end testing of the ETL -> Folder Generation (with refined rules) -> Frontend Navigation -> Item Display flow.
2.  **Gather User Feedback**: Specifically on the accuracy and coverage of the *refined* `parse_item_description_for_folders` logic.
3.  **Further Refine Parsing Rules (Iterative)**: Based on ongoing feedback and data analysis, continue to iteratively improve the parsing rules in `ml/training_pipeline.py` and `ml/inference.py` to handle more edge cases or new item description patterns.
4.  **UI/UX Review**: Review the display of folder names and item counts for clarity and user experience.
5.  **Address Pending Features**: Review other features from `projectbrief.md` (e.g., search, export, mini-dashboard) in light of the new classification approach.

## 4. Active Decisions & Considerations
- **Rule-Based Parsing as Primary Method**: The core classification now relies on explicit parsing rules, not unsupervised ML clustering.
- **Modularity is Key**: Continue to adhere to the modular structure.
- **User Experience for Folders**: The "Google Drive-like" navigation for the 2-level folder structure remains a core UX requirement.
- **Data Integrity**: Ensure all data transformations and displays are accurate.
- **Parsing Rule Maintainability**: The set of parsing rules will likely need to grow and be maintained as new item types are encountered. Consider how to make this manageable.

## 5. Important Patterns & Preferences (Emerging)
- **Structured Documentation**: The Memory Bank system is central.
- **Iterative Development & Testing**: The shift in requirements highlighted the need for quick iteration, testing, and debugging across the full stack.
- **User-Centric Design**: The folder structure is now directly tied to user-defined examples and expected categorization.

## 6. Learnings & Project Insights
- The project's classification approach has fundamentally changed from ML-driven clustering to explicit rule-based parsing. This requires significant changes to the "ML" components.
- Clear communication of requirements is vital, especially for complex concepts like "classification" or "foldering."
- The importance of robust and adaptable parsing rules for item descriptions is now paramount.
- Iterative testing and debugging across backend, data processing scripts, and frontend is crucial for ensuring data flows correctly and the UI reflects the intended structure.
